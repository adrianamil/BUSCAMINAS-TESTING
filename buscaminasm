import tkinter as tk
import random

class Buscaminas:
    def __init__(self, root, filas=10, columnas=10, num_minas=15):
        self.root = root
        self.filas = filas
        self.columnas = columnas
        self.num_minas = num_minas
        self.tablero = []
        self.botones = []
        self.estado_juego = "jugando"  # Estado: jugando, perdido, ganado
        self.casillas_reveladas = 0
        self.casillas_marcadas = 0
        self.bandera = 'F'

        self.generar_tablero()
        self.crear_interfaz()

    def generar_tablero(self):
        self.tablero = [[0 for _ in range(self.columnas)] for _ in range(self.filas)]
        
        minas_colocadas = 0
        while minas_colocadas < self.num_minas:
            fila = random.randint(0, self.filas - 1)
            columna = random.randint(0, self.columnas - 1)
            if self.tablero[fila][columna] != 'M':
                self.tablero[fila][columna] = 'M'
                minas_colocadas += 1

        # 👇 CORRECCIÓN AQUÍ
        for fila in range(self.filas):
            for col in range(self.columnas):
                if self.tablero[fila][col] == 'M':
                    continue
                for i in range(-1, 2):
                    for j in range(-1, 2):
                        if 0 <= fila + i < self.filas and 0 <= col + j < self.columnas:
                            if self.tablero[fila + i][col + j] == 'M':
                                self.tablero[fila][col] += 1

    def crear_interfaz(self):
        for fila in range(self.filas):
            fila_botones = []
            for columna in range(self.columnas):
                boton = tk.Button(self.root, width=3, height=1,
                                  command=lambda f=fila, c=columna: self.abrir_celda(f, c))
                boton.grid(row=fila, column=columna)
                boton.bind("<Button-3>", lambda event, f=fila, c=columna: self.marcar_bandera(f, c))
                fila_botones.append(boton)
            self.botones.append(fila_botones)

        self.estado = tk.Label(self.root, text="¡Juega Buscaminas!", font=("Arial", 14))
        self.estado.grid(row=self.filas, columnspan=self.columnas)

    def abrir_celda(self, fila, columna):
        if self.estado_juego != "jugando":
            return

        boton = self.botones[fila][columna]
        if boton['state'] == "disabled" or boton['text'] == self.bandera:
            return

        if self.tablero[fila][columna] == 'M':
            self.mostrar_minas()
            boton.config(text='M', bg="red")
            self.estado.config(text="¡Perdiste! Has tocado una mina.")
            self.estado_juego = "perdido"
        else:
            self.revelar(fila, columna)
            if self.casillas_reveladas == (self.filas * self.columnas - self.num_minas):
                self.estado.config(text="¡Felicidades! Has ganado.")
                self.estado_juego = "ganado"
                self.finalizar_juego()

    def revelar(self, fila, columna):
        if not (0 <= fila < self.filas and 0 <= columna < self.columnas):
            return

        boton = self.botones[fila][columna]
        if boton['state'] == "disabled" or boton['text'] == self.bandera:
            return

        valor = self.tablero[fila][columna]
        boton.config(text=str(valor) if valor > 0 else "", state="disabled", relief=tk.SUNKEN)
        self.casillas_reveladas += 1

        if valor == 0:
            for i in range(-1, 2):
                for j in range(-1, 2):
                    if i != 0 or j != 0:
                        self.revelar(fila + i, columna + j)

    def abrir_adyacentes(self, fila, columna):
        """Ya integrada dentro de 'revelar' ahora, no es necesaria por separado"""
        pass

    def mostrar_minas(self):
        for fila in range(self.filas):
            for col in range(self.columnas):
                if self.tablero[fila][col] == 'M':
                    self.botones[fila][col].config(text='M', bg="red")

    def marcar_bandera(self, fila, columna):
        if self.estado_juego != "jugando":
            return
        boton = self.botones[fila][columna]
        if boton['state'] == "disabled":
            return
        if boton['text'] == self.bandera:
            boton.config(text="")
            self.casillas_marcadas -= 1
        else:
            boton.config(text=self.bandera)
            self.casillas_marcadas += 1

    def finalizar_juego(self):
        for fila in range(self.filas):
            for col in range(self.columnas):
                self.botones[fila][col].config(state="disabled")


# Ejecutar juego
if __name__ == "__main__":
    root = tk.Tk()
    root.title("Buscaminas")
    juego = Buscaminas(root)
    root.mainloop()
